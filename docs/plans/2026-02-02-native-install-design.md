# Native Installation with Systemd/Launchd/NSSM Support

**Date:** 2026-02-02
**Status:** Draft

## Overview

Add a native installation path using `uv` with service management templates for Linux (systemd), macOS (launchd), and Windows (NSSM). The existing `--loop` scanning behavior remains unchanged.

## Goals

- Make taggarr installable via `uv sync` in a cloned repo
- Provide service templates for all major platforms
- Add XDG_CONFIG_HOME and Windows APPDATA config path support
- Document cross-platform installation in README

## Non-Goals

- `uv tool install` global installation (future enhancement)
- Filesystem watching or webhook-based autoscan triggers
- Replacing Docker as primary installation method

## Design

### 1. Migrate to uv-style Project Structure

**pyproject.toml changes:**

```toml
[project]
name = "taggarr"
version = "0.7.0"
description = "Dub Analysis & Tagging for Sonarr/Radarr"
requires-python = ">=3.9"
dependencies = [
    "requests>=2.32",
    "pymediainfo>=7.0",
    "pycountry>=24.6",
    "PyYAML>=6.0",
]

[project.scripts]
taggarr = "main:main"

[dependency-groups]
test = [
    "pytest>=7.0",
    "pytest-cov>=4.0",
    "pytest-mock>=3.0",
    "responses>=0.23",
]
dev = [
    "ruff",
]
```

**New files:**

- `uv.lock` - Generated by `uv sync`, committed to repo
- `test.sh` - Simple wrapper: `uv run pytest`

**Workflow:**

```bash
uv sync                    # Install deps
uv sync --group test       # Install with test deps
uv run taggarr --loop      # Run
uv run pytest              # Test
```

### 2. XDG_CONFIG_HOME and Windows APPDATA Support

**Config search order:**

Linux/macOS:

```
./taggarr.yaml
→ $XDG_CONFIG_HOME/taggarr/config.yaml
→ ~/.config/taggarr/config.yaml
→ /etc/taggarr/config.yaml
```

Windows:

```
./taggarr.yaml
→ %APPDATA%\taggarr\config.yaml
```

**Implementation in config_loader.py:**

```python
def get_config_paths():
    paths = [Path("taggarr.yaml")]

    if sys.platform == "win32":
        appdata = os.environ.get("APPDATA")
        if appdata:
            paths.append(Path(appdata) / "taggarr" / "config.yaml")
    else:
        xdg_config = os.environ.get("XDG_CONFIG_HOME")
        if xdg_config:
            paths.append(Path(xdg_config) / "taggarr" / "config.yaml")
        paths.append(Path.home() / ".config" / "taggarr" / "config.yaml")
        paths.append(Path("/etc/taggarr/config.yaml"))

    return paths
```

### 3. Service Templates

**Directory structure:**

```
contrib/
├── systemd/
│   ├── taggarr.user.service
│   └── taggarr.system.service
├── launchd/
│   └── com.taggarr.plist
└── nssm/
    └── install.ps1
```

#### Linux systemd - User Service

`contrib/systemd/taggarr.user.service`:

```ini
[Unit]
Description=Taggarr - Dub Analysis & Tagging
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
WorkingDirectory=%h/taggarr
ExecStart=/usr/bin/env uv run taggarr --loop
Restart=on-failure
RestartSec=30

[Install]
WantedBy=default.target
```

#### Linux systemd - System Service

`contrib/systemd/taggarr.system.service`:

```ini
[Unit]
Description=Taggarr - Dub Analysis & Tagging
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=taggarr
Group=taggarr
WorkingDirectory=/opt/taggarr
ExecStart=/usr/bin/env uv run taggarr --loop
Restart=on-failure
RestartSec=30

[Install]
WantedBy=multi-user.target
```

#### macOS launchd

`contrib/launchd/com.taggarr.plist`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.taggarr</string>
    <key>WorkingDirectory</key>
    <string>/Users/YOURUSER/taggarr</string>
    <key>ProgramArguments</key>
    <array>
        <string>/Users/YOURUSER/.local/bin/uv</string>
        <string>run</string>
        <string>taggarr</string>
        <string>--loop</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/Users/YOURUSER/Library/Logs/taggarr.log</string>
    <key>StandardErrorPath</key>
    <string>/Users/YOURUSER/Library/Logs/taggarr.error.log</string>
</dict>
</plist>
```

#### Windows NSSM

`contrib/nssm/install.ps1`:

```powershell
# Download NSSM from https://nssm.cc/download
# Run as Administrator

$serviceName = "taggarr"
$uvPath = "$env:USERPROFILE\.local\bin\uv.exe"
$workDir = "$env:USERPROFILE\taggarr"

nssm install $serviceName $uvPath run taggarr --loop
nssm set $serviceName AppDirectory $workDir
nssm set $serviceName AppStdout "$workDir\logs\service.log"
nssm set $serviceName AppStderr "$workDir\logs\service.error.log"
nssm start $serviceName
```

### 4. README Documentation

Add "Native Installation" section after Docker section:

````markdown
## Native Installation

### Prerequisites

- [uv](https://docs.astral.sh/uv/) package manager
- `mediainfo` system package:
  - **Linux:** `apt install mediainfo` or `dnf install mediainfo`
  - **macOS:** `brew install mediainfo`
  - **Windows:** Download from [MediaArea](https://mediaarea.net/en/MediaInfo/Download/Windows)

### Install

```bash
git clone https://github.com/STiXzoOR/taggarr.git
cd taggarr
uv sync
```
````

### Configure

```bash
# Linux/macOS
mkdir -p ~/.config/taggarr
cp taggarr.example.yaml ~/.config/taggarr/config.yaml

# Windows (PowerShell)
mkdir "$env:APPDATA\taggarr" -Force
cp taggarr.example.yaml "$env:APPDATA\taggarr\config.yaml"
```

### Run

```bash
uv run taggarr           # Single scan
uv run taggarr --loop    # Continuous mode
```

### Run as a Service

<details>
<summary>Linux (systemd user service)</summary>

```bash
cp contrib/systemd/taggarr.user.service ~/.config/systemd/user/taggarr.service
# Edit WorkingDirectory path if needed
systemctl --user daemon-reload
systemctl --user enable --now taggarr
systemctl --user status taggarr
```

</details>

<details>
<summary>Linux (systemd system service)</summary>

```bash
sudo useradd -r -s /bin/false taggarr
sudo cp -r . /opt/taggarr && sudo chown -R taggarr:taggarr /opt/taggarr
sudo cp contrib/systemd/taggarr.system.service /etc/systemd/system/taggarr.service
sudo systemctl daemon-reload
sudo systemctl enable --now taggarr
```

</details>

<details>
<summary>macOS (launchd)</summary>

```bash
cp contrib/launchd/com.taggarr.plist ~/Library/LaunchAgents/
# Edit paths in plist (replace YOURUSER with your username)
launchctl load ~/Library/LaunchAgents/com.taggarr.plist
```

</details>

<details>
<summary>Windows (NSSM)</summary>

1. Download [NSSM](https://nssm.cc/download) and add to PATH
2. Edit `contrib/nssm/install.ps1` paths if needed
3. Run PowerShell as Administrator:

```powershell
.\contrib\nssm\install.ps1
```

</details>
```

## Files to Create

| File                                     | Description                  |
| ---------------------------------------- | ---------------------------- |
| `test.sh`                                | Test runner: `uv run pytest` |
| `contrib/systemd/taggarr.user.service`   | Linux user service           |
| `contrib/systemd/taggarr.system.service` | Linux system service         |
| `contrib/launchd/com.taggarr.plist`      | macOS launchd agent          |
| `contrib/nssm/install.ps1`               | Windows NSSM installer       |

## Files to Modify

| File                       | Change                                            |
| -------------------------- | ------------------------------------------------- |
| `pyproject.toml`           | Migrate to dependency-groups, add project.scripts |
| `taggarr/config_loader.py` | Add XDG_CONFIG_HOME + APPDATA support             |
| `README.md`                | Add Native Installation section                   |

## Testing

- Verify `uv sync` installs all dependencies
- Verify `uv run taggarr --help` works
- Verify `uv run pytest` runs test suite
- Verify config loading from XDG_CONFIG_HOME
- Test systemd service on Linux
- Test launchd agent on macOS
- Test NSSM service on Windows

## References

- [Byparr](https://github.com/ThePhaseless/Byparr) - Reference for uv project structure
- [uv documentation](https://docs.astral.sh/uv/)
- [launchd tutorial](https://medium.com/@chetcorcos/a-simple-launchd-tutorial-9fecfcf2dbb3)
- [NSSM](https://nssm.cc/)
